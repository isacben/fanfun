pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
--name
--by author

function _init()
	t=0
	state="game"

	p_x=20
	p_y=96
	p_dx=0
	p_vy=0
	p_ay=0
	p_flip=false
	p_onground=true
	p_jumping=false
	p_flying=false
	
	gravity=0.2
	initial_acc=-2.6994
	alpha=2.251
	
	fans={}
	addfan(70,90)
	
	debug=""	
end

function _update60()
	update()
end

function _draw()
	cls(13)
	
	print(debug,0,120,7)
	draw()
end
-->8
--update

function update()
	if state=="title" then
		if btnp(5) then
			state="game"
		end
	
	elseif state=="game" then
		if btnp(5) then
			state="over"
		end
		p_move()
		fly()
		
	elseif state=="over" then
		if btnp(5) then
			state="title"
		end
	end
end
-->8
--draw

function draw()
	t+=1
	
	--title screen
	if state=="title" then
		title()
	
	--game screen
	elseif state=="game" then
		game()
		
	--game over screen
	elseif state=="over" then
		over()
	end
	
end

--title screen
function title()
	cprint("title",10,7)
	if t%26<18 then
		cprint("press ❎ to start",63,7)
	end
end

--game screen
function game()
	--cprint("playing",10,11)
	map()
	
	for fan in all(fans) do
		draw_fan(fan)
	end
	
	spr(1,p_x,p_y,1,1,p_flip)
	cprint("press ❎ to game over",122,7)
end

--gameover screen
function over()
	cprint("gameover",10,8)
	cprint("press ❎ to exit",63,8)
end
-->8
--player

function p_move()
	
	if btn(0) then
		p_dx=max(p_dx-0.2,-1.5)
		p_flip=true
	elseif btn(1) then
		p_dx=min(p_dx+0.2,1.5)
		p_flip=false
	else
		p_dx=p_dx-p_dx*0.1
		
		if abs(p_dx)<0.4 then
			p_dx=0
		end
	end
	
	
	if hit(p_x+p_dx,p_y,7,7) then
  p_dx=0
 end
	
	p_x+=p_dx
	
	
	--https://www.lexaloffle.com/bbs/?tid=43527
	if btn(4) and p_onground then
		p_ay=initial_acc
		p_onground=false
		p_jumping=true
	elseif btn(4) and p_jumping then
		p_ay+=alpha
		if p_ay>gravity then
			p_ay=gravity
			p_jumping=false
		end
	else
		if p_flying then
			p_ay=0
			p_vy=-1
		else
			p_ay=gravity
			p_jumping=false
		end
	end
	
	p_vy+=p_ay
			
	if hit(p_x,p_y+p_vy,7,7) then
 	if p_vy>0 then
 		p_onground=true
 	end   
  p_vy=0
	end
 
 debug=p_vy
 p_y+=p_vy
 
 
 
end

function fly()
	for fan in all(fans) do
		if p_x>fan.x-12 and 
			p_x+1<fan.x+8 and
			p_y<fan.y
			then
				
			
			
			--if hit(p_x,p_y+p_vy,7,7) then
				--p_vy=0
				--p_flying=false
		--	end
			
			p_onground=false
			p_flying=true
		else
			p_flying=false
			
		end
	end
end
-->8
--fans

function addfan(_x,_y)
	local _f={}
	_f.x=_x
	_f.y=_y
	
	add(fans,_f)
end


function draw_fan(fan)
	local _r=8
	circfill(fan.x,fan.y,_r,7)
	rectfill(fan.x-_r,fan.y-_r,fan.x+_r,fan.y,13)

	line(
		fan.x+3*sin(t/25),
		fan.y-t%25,
		fan.x+3*sin(t/25),
		fan.y-t%25,
		12
	)
end
-->8
--t5
-->8
--helpers

--centered text
function cprint(s,y,c)
		print(s,64-#s*2,y,c)
end

function hit(x,y,w,h)
  collide=false
  for i=x,x+w,w do
    if (fget(mget(i/8,y/8))>0) or
         (fget(mget(i/8,(y+h)/8))>0) then
          collide=true
    end
  end
  
  for i=y,y+h,h do
    if (fget(mget(x/8,i/8))>0) or
         (fget(mget((x+w)/8,i/8))>0) then
          collide=true
    end
  end
  
  return collide
end
__gfx__
00000000000500500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000055755750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700057777750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000057757550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000577777750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700577777750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000577777750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000055555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777707700000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006666607600000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006666607600000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007707777700000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006607666600000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006607666600000000
__gff__
0000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002e2e2e2e2e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002e2e2e2e2e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2e000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2e000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2e000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2e000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
